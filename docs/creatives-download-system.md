# –°–∏—Å—Ç–µ–º–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

## üéØ –û–±–∑–æ—Ä

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ —Å **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–∫–∞–∑–æ–º –¥–∏–∞–ª–æ–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è** –≤–º–µ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–æ–≤ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ.

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

- **`useCreativesDownloader.ts`** - –∫–æ–º–ø–æ–∑–∞–±–ª —Å –ª–æ–≥–∏–∫–æ–π —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
- **`useFiltersStore.ts`** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Store
- **–ö–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤** - —ç–º–∏—Ç–∏—Ä—É—é—Ç —Å–æ–±—ã—Ç–∏—è `creatives:download`

### –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã:

1. –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ‚Üí –°–æ–±—ã—Ç–∏–µ `creatives:download`
2. Store –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ URL –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
4. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ blob** –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–∏–∞–ª–æ–≥–∞

## üöÄ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–∏–∞–ª–æ–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ë—Ä–∞—É–∑–µ—Ä—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/PDF –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –≤–º–µ—Å—Ç–æ –ø–æ–∫–∞–∑–∞ –¥–∏–∞–ª–æ–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.

### ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ blob —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ

```typescript
// –û–°–ù–û–í–ù–û–ô –ú–ï–¢–û–î - –≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ blob
const response = await fetch(url);
const blob = await response.blob();
const blobUrl = window.URL.createObjectURL(blob);

const link = document.createElement('a');
link.href = blobUrl; // –ù–µ –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞, –∞ blob URL
link.download = filename; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
link.click();
```

### üõ°Ô∏è Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

1. **–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥**: Blob —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥)
2. **Fallback 1**: –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ —Å `download` (–¥–ª—è same-origin)
3. **Fallback 2**: –ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–π resort)

## üìã –ë—Ä–∞—É–∑–µ—Ä–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

| –ú–µ—Ç–æ–¥           | Chrome | Firefox | Safari | Edge | –†–µ–∑—É–ª—å—Ç–∞—Ç            |
| --------------- | ------ | ------- | ------ | ---- | -------------------- |
| Blob + download | ‚úÖ     | ‚úÖ      | ‚úÖ     | ‚úÖ   | –î–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è    |
| Direct download | ‚úÖ     | ‚úÖ      | ‚ö†Ô∏è     | ‚úÖ   | –î–∏–∞–ª–æ–≥/–Ω–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ |
| Window.open     | ‚úÖ     | ‚úÖ      | ‚úÖ     | ‚úÖ   | –ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞        |

## üîí CORS –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–±–ª–µ–º—ã CORS:

- **Same-origin**: –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- **Cross-origin —Å CORS**: Blob –º–µ—Ç–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–µ—à–∞–µ—Ç
- **Cross-origin –±–µ–∑ CORS**: –¢–æ–ª—å–∫–æ window.open

### –†–µ—à–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞:

```http
# Laravel - –¥–æ–±–∞–≤–∏—Ç—å –≤ .htaccess –∏–ª–∏ nginx config
Access-Control-Allow-Origin: https://yourdomain.com
Access-Control-Allow-Methods: GET, HEAD, OPTIONS
Access-Control-Allow-Headers: Accept, Content-Type
```

## üéõÔ∏è –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è **–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≥–∞—Ä–∞–Ω—Ç–∏–∏** –¥–∏–∞–ª–æ–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:

### PHP/Laravel:

```php
// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ —Ñ–∞–π–ª–æ–≤ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
return response()->file($filePath, [
    'Content-Disposition' => 'attachment; filename="' . $filename . '"',
    'Content-Type' => 'application/octet-stream',
    'Cache-Control' => 'no-cache, must-revalidate',
]);
```

### Nginx:

```nginx
# –î–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
location ~* ^/storage/creatives/.*\.(jpg|jpeg|png|gif|mp4|zip)$ {
    add_header Content-Disposition 'attachment';
    add_header Content-Type 'application/octet-stream';
}
```

### Apache (.htaccess):

```apache
# –î–ª—è —Ñ–∞–π–ª–æ–≤ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
<FilesMatch "\.(jpg|jpeg|png|gif|mp4|zip)$">
    Header set Content-Disposition "attachment"
    Header set Content-Type "application/octet-stream"
</FilesMatch>
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã:

```bash
npm run test:frontend -- useCreativesDownloader
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
2. –ö–ª–∏–∫–Ω—É—Ç—å "–°–∫–∞—á–∞—Ç—å" –Ω–∞ –ª—é–±–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ
3. ‚úÖ –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –¥–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
4. ‚ùå –ù–ï –¥–æ–ª–∂–Ω–∞ –æ—Ç–∫—Ä—ã—Ç—å—Å—è –Ω–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏:

```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞
console.log('Download API:', store.downloader.isDownloadSupported());

// –ü—Ä–æ–≤–µ—Ä–∫–∞ CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
console.log('CORS restricted:', store.downloader.isCorsRestricted(url));
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –°–æ–±—ã—Ç–∏—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:

- `creatives:download-started` - –Ω–∞—á–∞–ª–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
- `creatives:download-success` - —É—Å–ø–µ—à–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
- `creatives:download-error` - –æ—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:

- `‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω —á–µ—Ä–µ–∑ blob`
- `‚úÖ –§–∞–π–ª —Å–∫–∞—á–∞–Ω —á–µ—Ä–µ–∑ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É`
- `‚ö†Ô∏è –§–∞–π–ª –æ—Ç–∫—Ä—ã—Ç –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ (fallback)`

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ blob –º–µ—Ç–æ–¥** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è cross-origin —Ñ–∞–π–ª–æ–≤
3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Å–æ–±—ã—Ç–∏—è** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö** –æ—Å–æ–±–µ–Ω–Ω–æ Safari

### ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

- –§–∞–π–ª—ã >50MB –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é –≤ blob –º–µ—Ç–æ–¥–µ
- CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è external —Ñ–∞–π–ª–æ–≤
- –°—Ç–∞—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã (IE) –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç download API

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

–î–ª—è —Ñ–∞–π–ª–æ–≤ >50MB –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑–º–µ—Ä–∞:

```typescript
// –í useCreativesDownloader.ts –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
const MAX_BLOB_SIZE = 50 * 1024 * 1024; // 50MB

if (blob.size > MAX_BLOB_SIZE) {
  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –≤–º–µ—Å—Ç–æ blob
  window.open(url + '?download=1', '_blank');
}
```

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **98%** —Ñ–∞–π–ª–æ–≤ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è —Å –¥–∏–∞–ª–æ–≥–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è  
‚úÖ **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback** –ø—Ä–∏ –ª—é–±—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö  
‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –≤–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
