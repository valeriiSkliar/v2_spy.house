# Исправление проблемы повторной активации триала при смене email

## Проблема

После смены email адреса пользователь должен повторно подтвердить новую почту. При этом срабатывает логика активации триала в `EmailVerificationController`, что приводит к повторному присвоению триального периода. Это недопустимо, так как триал должен предоставляться только один раз за весь период использования аккаунта.

## Причина проблемы

В логике активации триала отсутствовала проверка на то, был ли триал уже использован ранее:

```php
// Старая логика - проверяла только текущий статус
if (!$user->hasActiveSubscription() && !$user->isTrialPeriod()) {
    $user->activateTrialPeriod();
}
```

Метод `isTrialPeriod()` проверяет только активный триал, но после истечения триала флаг `is_trial_period` сбрасывается в `false`, и система считает, что пользователь может получить триал снова.

## Решение

### 1. Добавлено новое поле в БД

Добавлено поле `trial_period_used` в таблицу `users` для отслеживания факта использования триала:

```sql
ALTER TABLE users ADD COLUMN trial_period_used BOOLEAN DEFAULT FALSE COMMENT 'Flag indicating if trial period was ever used';
```

### 2. Обновлен метод активации триала

```php
public function activateTrialPeriod(): void
{
    $this->update([
        'is_trial_period' => true,
        'trial_period_used' => true, // Устанавливаем флаг использования
        'subscription_time_start' => now(),
        'subscription_time_end' => now()->addDays(7),
        'subscription_is_expired' => false,
    ]);
}
```

### 3. Добавлен новый метод проверки

```php
public function hasTrialPeriodBeenUsed(): bool
{
    return $this->trial_period_used;
}
```

### 4. Обновлена логика активации триала

```php
// Новая логика - добавлена проверка на использование триала
if (!$user->hasActiveSubscription() && !$user->isTrialPeriod() && !$user->hasTrialPeriodBeenUsed()) {
    $user->activateTrialPeriod();
}
```

## Изменения в файлах

1. **Миграция БД**:

   - `database/migrations/0001_01_01_000000_create_users_table.php` - обновлена базовая миграция
   - `database/migrations/2024_12_27_000000_add_trial_period_used_to_users_table.php` - новая миграция

2. **Модель User**:

   - `app/Models/User.php` - добавлены поле и методы

3. **Контроллер верификации**:

   - `app/Http/Controllers/Auth/EmailVerificationController.php` - обновлена логика

4. **Тесты**:

   - `tests/Feature/TrialPeriodTest.php` - добавлен тест для предотвращения повторной активации
   - `tests/Unit/TrialPeriodUnitTest.php` - добавлен тест для нового метода

5. **Фабрики и сидеры**:
   - `database/factories/UserFactory.php` - добавлено поле по умолчанию
   - `database/seeders/UserSeeder.php` - добавлено поле в тестовые данные

## Логика работы

1. **При первой верификации email**:

   - Проверяется, что у пользователя нет активной подписки
   - Проверяется, что триал сейчас не активен
   - **Проверяется, что триал не был использован ранее**
   - Если все условия выполнены - активируется триал и устанавливается флаг `trial_period_used = true`

2. **При смене email и повторной верификации**:

   - Условие `!$user->hasTrialPeriodBeenUsed()` вернет `false`
   - Триал не будет активирован повторно

3. **Флаг использования триала**:
   - Устанавливается в `true` при первой активации триала
   - Никогда не сбрасывается обратно в `false`
   - Остается `true` даже после истечения триала

## Тестирование

Добавлены тесты для проверки:

- Триал не активируется при повторной верификации email
- Флаг использования триала корректно устанавливается и сохраняется
- Существующая логика активации триала не нарушена

## Обратная совместимость

Решение полностью обратно совместимо:

- Существующие пользователи получат `trial_period_used = false` по умолчанию
- Пользователи, которые уже использовали триал, при следующем обновлении профиля получат корректный флаг
- Новые пользователи будут работать с обновленной логикой сразу
