graph TD
    %% –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
    Users["`**users**
    id, available_balance
    subscription_id, subscription_time_start
    subscription_time_end, subscription_is_expired
    queued_subscription_id, balance_version`"]
    
    Payments["`**payments**
    id, user_id, amount, payment_type
    subscription_id, payment_method
    transaction_number, promocode_id
    status, webhook_token, webhook_processed_at
    idempotency_key, parent_payment_id`"]
    
    Subscriptions["`**subscriptions**
    id, name, amount, early_discount
    api_request_count, search_request_count
    status`"]
    
    Promocodes["`**promocodes**
    id, promocode, discount, status
    date_start, date_end, count_activation
    max_per_user, created_by_user_id`"]
    
    PromocodeActivations["`**promocode_activations**
    id, promocode_id, user_id
    payment_id, ip_address
    user_agent, created_at`"]

    %% –ù–û–í–´–ï –¢–ê–ë–õ–ò–¶–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò –ò –ê–£–î–ò–¢–ê
    
    BalanceAudit["`**üÜï balance_audit**
    id, user_id, amount
    operation_type, payment_id
    balance_before, balance_after
    transaction_hash, created_at`"]
    
    WebhookLogs["`**üÜï webhook_logs**
    id, payment_id, webhook_token
    request_body, request_headers
    ip_address, processed_at
    response_status, nonce, signature_valid`"]
    
    SubscriptionAudit["`**üÜï subscription_audit**
    id, user_id, subscription_id
    action, previous_subscription_id
    payment_id, created_at`"]
    
    FinancialReconciliation["`**üÜï financial_reconciliation**
    id, date, payment_system
    our_total_amount, external_total_amount
    discrepancy, status, reconciled_at`"]
    
    RateLimiting["`**üÜï rate_limiting**
    id, ip_address, endpoint
    request_count, window_start
    blocked_until`"]
    
    SecurityAlerts["`**üÜï security_alerts**
    id, alert_type, user_id
    payment_id, description
    severity, resolved, created_at`"]

    TransactionLimits["`**üÜï transaction_limits**
    id, user_id, daily_limit
    monthly_limit, current_daily_amount
    current_monthly_amount, last_reset_daily
    last_reset_monthly`"]

    %% –°–≤—è–∑–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
    Users -->|subscription_id| Subscriptions
    Payments -->|user_id| Users
    Payments -->|subscription_id| Subscriptions
    Payments -->|promocode_id| Promocodes
    Payments -->|parent_payment_id| Payments
    PromocodeActivations -->|promocode_id| Promocodes
    PromocodeActivations -->|user_id| Users
    PromocodeActivations -->|payment_id| Payments
    
    %% –°–≤—è–∑–∏ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
    BalanceAudit -->|user_id| Users
    BalanceAudit -->|payment_id| Payments
    WebhookLogs -->|payment_id| Payments
    SubscriptionAudit -->|user_id| Users
    SubscriptionAudit -->|subscription_id| Subscriptions
    SubscriptionAudit -->|payment_id| Payments
    SecurityAlerts -->|user_id| Users
    SecurityAlerts -->|payment_id| Payments
    TransactionLimits -->|user_id| Users
    
    %% –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    SecureDepositFlow["`üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ**
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ ‚Üí Optimistic locking
    ‚Üí Audit –∑–∞–ø–∏—Å—å ‚Üí Webhook —Å nonce
    ‚Üí Rate limiting –ø—Ä–æ–≤–µ—Ä–∫–∞`"]
    
    SecureDirectSubFlow["`üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏**
    –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ + IP ‚Üí Idempotency key
    ‚Üí Transaction limits ‚Üí Audit trail
    ‚Üí Webhook –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å`"]
    
    SecureBalanceSubFlow["`üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å –±–∞–ª–∞–Ω—Å–∞**
    SELECT FOR UPDATE –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
    ‚Üí Balance version –ø—Ä–æ–≤–µ—Ä–∫–∞
    ‚Üí –î–≤–æ–π–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Üí Audit –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ`"]
    
    %% –í–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏
    EnhancedPaymentSystems["`üîí **–ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã**
    TetherUSDT + signature verification
    Pay2.House + rate limiting
    HMAC-SHA256 –ø–æ–¥–ø–∏—Å–∏ + Timestamp validation`"]
    
    SecureWebhookEndpoint["`üîí **Secure Webhook**
    IP whitelist ‚Üí HMAC signature validation
    ‚Üí Nonce replay –∑–∞—â–∏—Ç–∞ ‚Üí Rate limiting
    ‚Üí –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí Audit trail`"]
    
    EnhancedCronJobs["`üîí **–£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏**
    Failover –º–µ—Ö–∞–Ω–∏–∑–º + Dead letter queue
    Alert —Å–∏—Å—Ç–µ–º–∞ + Reconciliation –ø—Ä–æ–≤–µ—Ä–∫–∏
    Balance integrity checks`"]
    
    MonitoringSystem["`üìä **–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**
    Real-time alerts + Anomaly detection
    Financial reconciliation + Performance metrics
    Security monitoring`"]
    
    %% –ü–æ—Ç–æ–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    SecureDepositFlow --> Payments
    SecureDepositFlow --> BalanceAudit
    SecureDepositFlow --> TransactionLimits
    
    SecureDirectSubFlow --> Payments
    SecureDirectSubFlow --> SubscriptionAudit
    SecureDirectSubFlow --> SecurityAlerts
    
    SecureBalanceSubFlow --> Payments
    SecureBalanceSubFlow --> BalanceAudit
    SecureBalanceSubFlow --> SubscriptionAudit
    
    EnhancedPaymentSystems -->|secure webhook| SecureWebhookEndpoint
    SecureWebhookEndpoint --> WebhookLogs
    SecureWebhookEndpoint --> Payments
    SecureWebhookEndpoint --> SecurityAlerts
    
    EnhancedCronJobs --> Users
    EnhancedCronJobs --> FinancialReconciliation
    EnhancedCronJobs --> SecurityAlerts
    
    MonitoringSystem --> FinancialReconciliation
    MonitoringSystem --> SecurityAlerts
    MonitoringSystem --> BalanceAudit
    
    %% Rate Limiting System
    SecureWebhookEndpoint --> RateLimiting
    SecureDepositFlow --> RateLimiting
    
    %% ENUM –∑–Ω–∞—á–µ–Ω–∏—è (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ)
    PaymentTypes["`**payment_type ENUM**
    DEPOSIT | DIRECT_SUBSCRIPTION
    BALANCE_SUBSCRIPTION | REFUND | CHARGEBACK`"]
    
    PaymentMethods["`**payment_method ENUM**
    TetherUSDT | Pay2.House
    INTERNAL_BALANCE | ADMIN_ADJUSTMENT`"]
    
    PaymentStatuses["`**status ENUM**
    PENDING | SUCCESS | FAILED
    REFUNDED | DISPUTED | CANCELLED`"]

    AlertTypes["`**alert_type ENUM**
    SUSPICIOUS_ACTIVITY | DUPLICATE_WEBHOOK
    BALANCE_MISMATCH | RATE_LIMIT_EXCEEDED
    PROMOCODE_ABUSE | RECONCILIATION_ERROR`"]
    
    %% –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
    classDef tableStyle fill:#e1f5fe,stroke:#0277bd,stroke-width:2px,color:#000
    classDef newTableStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px,color:#000
    classDef secureProcessStyle fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef enumStyle fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef systemStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    
    class Users,Payments,Subscriptions,Promocodes,PromocodeActivations tableStyle
    class BalanceAudit,WebhookLogs,SubscriptionAudit,FinancialReconciliation,RateLimiting,SecurityAlerts,TransactionLimits newTableStyle
    class SecureDepositFlow,SecureDirectSubFlow,SecureBalanceSubFlow,SecureWebhookEndpoint,EnhancedCronJobs,MonitoringSystem secureProcessStyle
    class PaymentTypes,PaymentMethods,PaymentStatuses,AlertTypes enumStyle
    class EnhancedPaymentSystems systemStyle