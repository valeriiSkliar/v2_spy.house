graph TD
    %% ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –¢–ê–ë–õ–ò–¶–´ (–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
    Users["`‚úÖ **users** (—á–∞—Å—Ç–∏—á–Ω–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π)
    id, available_balance (DECIMAL 10,2)
    subscription_id, subscription_time_start
    subscription_time_end, subscription_is_expired
    queued_subscription_id, balance_version`"]
    
    Payments["`‚úÖ **payments** (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)
    id, user_id, amount (DECIMAL 15,2)
    payment_type ENUM, subscription_id
    payment_method ENUM, transaction_number
    promocode_id, status ENUM
    webhook_token, webhook_processed_at
    idempotency_key, invoice_number
    external_number (Pay2House)`"]
    
    Subscriptions["`‚úÖ **subscriptions** (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
    id, name, amount (DECIMAL 10,2)
    early_discount (DECIMAL 5,2)
    api_request_count, search_request_count
    status ENUM (active,inactive,deprecated)`"]
    
    Promocodes["`‚úÖ **promocodes** (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)
    id, promocode (VARCHAR 50), discount (DECIMAL 5,2)
    status ENUM, date_start, date_end
    count_activation, max_per_user
    created_by_user_id`"]
    
    PromocodeActivations["`‚úÖ **promocode_activations** (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)
    id, promocode_id, user_id
    payment_id, ip_address
    user_agent, created_at`"]

    %% ‚ùå –ü–õ–ê–ù–ò–†–£–ï–ú–´–ï –¢–ê–ë–õ–ò–¶–´ (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–´)
    
    BalanceAudit["`‚ùå **balance_audit** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    id, user_id, amount
    operation_type, payment_id
    balance_before, balance_after
    transaction_hash, created_at`"]
    
    WebhookLogs["`‚ùå **webhook_logs** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    id, payment_id, webhook_token
    request_body, request_headers
    ip_address, processed_at
    response_status, nonce, signature_valid`"]
    
    SubscriptionAudit["`‚ùå **subscription_audit** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    id, user_id, subscription_id
    action, previous_subscription_id
    payment_id, created_at`"]
    
    FinancialReconciliation["`‚ùå **financial_reconciliation** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    id, date, payment_system
    our_total_amount, external_total_amount
    discrepancy, status, reconciled_at`"]
    
    RateLimiting["`‚ùå **rate_limiting** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    id, ip_address, endpoint
    request_count, window_start
    blocked_until`"]
    
    SecurityAlerts["`‚ùå **security_alerts** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    id, alert_type, user_id
    payment_id, description
    severity, resolved, created_at`"]

    TransactionLimits["`‚ùå **transaction_limits** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    id, user_id, daily_limit
    monthly_limit, current_daily_amount
    current_monthly_amount, last_reset_daily
    last_reset_monthly`"]

    %% ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –°–í–Ø–ó–ò
    Users -->|subscription_id| Subscriptions
    Payments -->|user_id| Users
    Payments -->|subscription_id| Subscriptions
    Payments -->|promocode_id| Promocodes
    PromocodeActivations -->|promocode_id| Promocodes
    PromocodeActivations -->|user_id| Users
    PromocodeActivations -->|payment_id| Payments
    
    %% ‚ùå –ü–õ–ê–ù–ò–†–£–ï–ú–´–ï –°–í–Ø–ó–ò (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–´)
    BalanceAudit -.->|user_id| Users
    BalanceAudit -.->|payment_id| Payments
    WebhookLogs -.->|payment_id| Payments
    SubscriptionAudit -.->|user_id| Users
    SubscriptionAudit -.->|subscription_id| Subscriptions
    SubscriptionAudit -.->|payment_id| Payments
    SecurityAlerts -.->|user_id| Users
    SecurityAlerts -.->|payment_id| Payments
    TransactionLimits -.->|user_id| Users
    
    %% ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –ü–†–û–¶–ï–°–°–´ (–¢–µ–∫—É—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
    CurrentDirectSubFlow["`‚úÖ **–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏**
    1. –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ ‚Üí TariffController::processPayment
    2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è external_number ‚Üí Pay2Service::createPayment  
    3. –°–æ–∑–¥–∞–Ω–∏–µ Payment –∑–∞–ø–∏—Å–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º PENDING
    4. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ Pay2.House ‚Üí –û–ø–ª–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    5. Pay2.House –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook ‚Üí Pay2WebhookController::handle
    6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
    7. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    8. –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ success/cancel —Å—Ç—Ä–∞–Ω–∏—Ü—ã`"]
    
    CurrentPromocodeFlow["`‚úÖ **–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤**
    1. PromocodeService::validatePromocode
    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –∏ –¥–∞—Ç
    3. PromocodeService::applyPromocode
    4. –°–æ–∑–¥–∞–Ω–∏–µ PromocodeActivation –∑–∞–ø–∏—Å–∏
    5. IP –∏ User-Agent –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ`"]
    
    %% ‚ùå –ü–õ–ê–ù–ò–†–£–ï–ú–´–ï –ü–†–û–¶–ï–°–°–´ (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–´)
    PlannedDepositFlow["`‚ùå **–ü–ª–∞–Ω–∏—Ä—É–µ–º–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ ‚Üí Optimistic locking
    ‚Üí Audit –∑–∞–ø–∏—Å—å ‚Üí Webhook —Å nonce
    ‚Üí Rate limiting –ø—Ä–æ–≤–µ—Ä–∫–∞`"]
    
    PlannedBalanceSubFlow["`‚ùå **–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –æ–ø–ª–∞—Ç–∞ —Å –±–∞–ª–∞–Ω—Å–∞** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    SELECT FOR UPDATE –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
    ‚Üí Balance version –ø—Ä–æ–≤–µ—Ä–∫–∞
    ‚Üí –î–≤–æ–π–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Üí Audit –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ`"]
    
    %% üîÑ –ß–ê–°–¢–ò–ß–ù–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –°–ò–°–¢–ï–ú–´
    CurrentPaymentSystems["`üîÑ **–ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã** (—á–∞—Å—Ç–∏—á–Ω–æ)
    ‚úÖ Pay2.House –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è + HMAC –ø–æ–¥–ø–∏—Å–∏
    ‚ùå TetherUSDT –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
    ‚ùå Rate limiting –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç`"]
    
    Pay2WebhookController["`‚úÖ **Pay2WebhookController** (–†–ï–ê–õ–ò–ó–û–í–ê–ù!)
    ‚úÖ Pay2WebhookController::handle() –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook'–∏
    ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ HMAC –ø–æ–¥–ø–∏—Å–∏ (–≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º–µ)
    ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π
    ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
    ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤: paid, cancelled, error
    ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π`"]
    
    %% ‚úÖ –¢–ï–ö–£–©–ò–ï –ü–û–¢–û–ö–ò –ü–†–û–¶–ï–°–°–û–í  
    CurrentDirectSubFlow --> Payments
    CurrentDirectSubFlow --> Users
    CurrentPromocodeFlow --> PromocodeActivations
    CurrentPaymentSystems -->|working webhook| Pay2WebhookController
    Pay2WebhookController --> Payments
    Pay2WebhookController --> Users
    
    %% ‚ùå –ü–õ–ê–ù–ò–†–£–ï–ú–´–ï –ü–û–¢–û–ö–ò (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–´)
    PlannedDepositFlow -.-> BalanceAudit
    PlannedDepositFlow -.-> TransactionLimits
    PlannedBalanceSubFlow -.-> BalanceAudit
    PlannedBalanceSubFlow -.-> SubscriptionAudit
    
    %% ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï ENUM –∑–Ω–∞—á–µ–Ω–∏—è
    PaymentTypesActual["`‚úÖ **payment_type ENUM** (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
    DEPOSIT | DIRECT_SUBSCRIPTION`"]
    
    PaymentMethodsActual["`‚úÖ **payment_method ENUM** (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
    USDT | PAY2_HOUSE | USER_BALANCE`"]
    
    PaymentStatusesActual["`‚úÖ **status ENUM** (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
    PENDING | SUCCESS | FAILED`"]
    
    PromocodeStatusesActual["`‚úÖ **promocode_status ENUM** (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
    active | inactive | expired | exhausted`"]

    %% ‚ùå –ü–õ–ê–ù–ò–†–£–ï–ú–´–ï ENUM (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–´)
    PaymentTypesPlanned["`‚ùå **payment_type** (–ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ)
    BALANCE_SUBSCRIPTION | REFUND | CHARGEBACK`"]
    
    PaymentMethodsPlanned["`‚ùå **payment_method** (–ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ)
    TetherUSDT | INTERNAL_BALANCE | ADMIN_ADJUSTMENT`"]
    
    PaymentStatusesPlanned["`‚ùå **status** (–ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ)
    REFUNDED | DISPUTED | CANCELLED`"]

    AlertTypesPlanned["`‚ùå **alert_type ENUM** (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
    SUSPICIOUS_ACTIVITY | DUPLICATE_WEBHOOK
    BALANCE_MISMATCH | RATE_LIMIT_EXCEEDED
    PROMOCODE_ABUSE | RECONCILIATION_ERROR`"]
    
    %% –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
    classDef implementedStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px,color:#000
    classDef notImplementedStyle fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef partialStyle fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef enumImplementedStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef enumPlannedStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#000
    
    %% ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    class Users,Payments,Subscriptions,Promocodes,PromocodeActivations implementedStyle
    class CurrentDirectSubFlow,CurrentPromocodeFlow,Pay2WebhookController implementedStyle
    class PaymentTypesActual,PaymentMethodsActual,PaymentStatusesActual,PromocodeStatusesActual enumImplementedStyle
    
    %% üîÑ –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ
    class CurrentPaymentSystems partialStyle
    
    %% ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã  
    class BalanceAudit,WebhookLogs,SubscriptionAudit,FinancialReconciliation,RateLimiting,SecurityAlerts,TransactionLimits notImplementedStyle
    class PlannedDepositFlow,PlannedBalanceSubFlow notImplementedStyle
    class PaymentTypesPlanned,PaymentMethodsPlanned,PaymentStatusesPlanned,AlertTypesPlanned enumPlannedStyle