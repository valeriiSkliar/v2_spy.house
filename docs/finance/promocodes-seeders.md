# 🎫 Документация по сидерам промокодов

Этот документ описывает тестовые данные, созданные сидерами для системы промокодов.

## 📋 Порядок выполнения сидеров

Сидеры должны выполняться в строго определенном порядке из-за зависимостей между таблицами:

1. **UserSeeder** - создает пользователей
2. **SubscriptionSeeder** - создает подписки
3. **PaymentSeeder** - создает платежи (требует пользователей и подписки)
4. **PromocodeSeeder** - создает промокоды
5. **PromocodeActivationSeeder** - создает активации промокодов (требует пользователей, промокоды и платежи)

## 💰 PaymentSeeder

Создает разнообразные платежи для тестирования системы промокодов и финансовых операций.

### Типы платежей:

- **Успешные платежи за подписки** - для тестирования применения промокодов
- **Депозитные платежи** - пополнения баланса через USDT
- **Платежи с баланса** - покупки подписок через USER_BALANCE
- **Ожидающие платежи** - статус PENDING
- **Неудачные платежи** - статус FAILED
- **Тестовые суммы** - платежи с конкретными суммами (100, 50, 200, 75, 150)

### Методы оплаты:

- `UDST` - Tether USDT
- `PAY2_HOUSE` - Pay2.House
- `USER_BALANCE` - Баланс пользователя

### Статистика:

Создается ~40+ платежей различных типов для полноценного тестирования.

## 🎫 PromocodeSeeder - Обзор

Созданы сидеры для заполнения базы данных тестовыми данными промокодов и их активаций.

## Доступные сидеры

### PromocodeSeeder

Создает тестовые промокоды различных типов:

**Именованные промокоды:**

- `WELCOME10` - 10% скидка, новые пользователи
- `SAVE20` - 20% скидка, можно использовать 2 раза
- `BIGDEAL50` - 50% скидка, ограничен по времени
- `FOREVER15` - 15% скидка без ограничений по времени
- `INACTIVE25` - неактивный промокод (для тестирования)
- `EXPIRED30` - истекший промокод
- `UNLIMITED5` - 5% скидка с высоким лимитом (10 использований)
- `VIP40` - 40% скидка для VIP клиентов

**Дополнительно:**

- 10 случайных активных промокодов
- 3 неактивных промокода
- 2 истекших промокода

### PromocodeActivationSeeder

Создает реалистичные активации промокодов:

**Сценарии активаций:**

- Несколько пользователей активировали WELCOME10
- SAVE20 использовали 5 разных пользователей
- FOREVER15 - популярный промокод с множественными активациями
- Случайные активации для других промокодов

**Специальные тестовые данные:**

- Активации привязанные к платежам (если они есть)
- Подозрительная активность с одного IP (для тестирования антифрода)
- 20 дополнительных случайных активаций

## Запуск сидеров

### Запуск всех сидеров

```bash
php artisan db:seed
```

### Запуск только сидеров промокодов

```bash
# Сначала промокоды
php artisan db:seed --class=PromocodeSeeder

# Затем активации (зависят от промокодов)
php artisan db:seed --class=PromocodeActivationSeeder
```

### Пересоздание базы с сидерами

```bash
php artisan migrate:fresh --seed
```

## Зависимости сидеров

1. **PromocodeSeeder** - создает пользователя-админа, если нет пользователей
2. **PromocodeActivationSeeder** - требует:
   - Существующие промокоды (PromocodeSeeder)
   - Пользователей в системе
   - Опционально: платежи для привязки активаций

## Порядок выполнения

Сидеры добавлены в `DatabaseSeeder` в правильном порядке:

```php
$this->call([
    // ... другие сидеры
    SubscriptionSeeder::class,
    PromocodeSeeder::class,        // ← Сначала промокоды
    PromocodeActivationSeeder::class, // ← Потом активации
]);
```

## Что создается

После выполнения сидеров у вас будет:

- **~23 промокода** различных типов и статусов
- **50+ активаций** с реалистичными сценариями использования
- **Тестовые данные** для всех функций системы промокодов
- **Данные для тестирования** безопасности и обнаружения злоупотреблений

## Использование в тестах

```php
// В тестах можно использовать конкретные сидеры
$this->seed(PromocodeSeeder::class);
$this->seed(PromocodeActivationSeeder::class);

// Или через DatabaseSeeder
$this->seed();
```

## Полезные команды

```bash
# Посмотреть количество созданных записей
php artisan tinker
>>> App\Finance\Models\Promocode::count()
>>> App\Finance\Models\PromocodeActivation::count()

# Найти промокод по коду
>>> App\Finance\Models\Promocode::findByCode('WELCOME10')

# Получить статистику по пользователю
>>> $service = new App\Finance\Services\PromocodeService();
>>> $stats = $service->getUserPromocodeStats(1);
```
