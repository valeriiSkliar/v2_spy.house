# –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ üé´

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–ª—É—á–∞—Ç—å —Å–∫–∏–¥–∫–∏ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ú–æ–¥–µ–ª–∏

- `Promocode` - –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –ø—Ä–æ–º–æ–∫–æ–¥–∞
- `PromocodeActivation` - –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

### –°–µ—Ä–≤–∏—Å—ã

- `PromocodeService` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏

## –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞

```php
use App\Finance\Services\PromocodeService;

$service = new PromocodeService();

$promocode = $service->createPromocode([
    'promocode' => 'SAVE20', // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    'discount' => 20.00,     // –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏
    'status' => PromocodeStatus::ACTIVE,
    'date_start' => now(),
    'date_end' => now()->addDays(30),
    'max_per_user' => 1,     // –º–∞–∫—Å–∏–º—É–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
], $createdByUserId);
```

## –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞

```php
try {
    $result = $service->validatePromocode('SAVE20', $userId, 100.00);

    // $result —Å–æ–¥–µ—Ä–∂–∏—Ç:
    // - valid: true
    // - promocode_id: ID –ø—Ä–æ–º–æ–∫–æ–¥–∞
    // - discount_percentage: –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏
    // - discount_amount: —Å—É–º–º–∞ —Å–∫–∏–¥–∫–∏
    // - original_amount: –∏—Å—Ö–æ–¥–Ω–∞—è —Å—É–º–º–∞
    // - final_amount: —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ—Å–ª–µ —Å–∫–∏–¥–∫–∏

} catch (ValidationException $e) {
    // –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
    echo $e->getMessage();
}
```

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞

```php
try {
    $result = $service->applyPromocode(
        'SAVE20',
        $userId,
        100.00,
        request()->ip(),
        request()->userAgent(),
        $paymentId // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    );

    // –ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω
    $activationId = $result['activation_id'];

} catch (ValidationException $e) {
    // –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
    echo $e->getMessage();
}
```

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```php
$stats = $service->getUserPromocodeStats($userId);

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
// - total_activations: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π
// - total_saved: –æ–±—â–∞—è —Å—É–º–º–∞ —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
// - activations: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è

```php
$isAbuse = $service->checkForAbuse($ipAddress, $userId);

if ($isAbuse) {
    // –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å - –º–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π —Å –æ–¥–Ω–æ–≥–æ IP
}
```

## –°—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

- `ACTIVE` - –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥
- `INACTIVE` - –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥
- `EXPIRED` - –∏—Å—Ç–µ–∫—à–∏–π –ø—Ä–æ–º–æ–∫–æ–¥
- `EXHAUSTED` - –∏—Å—á–µ—Ä–ø–∞–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥

## –ú–µ—Ç–æ–¥—ã –º–æ–¥–µ–ª–∏ Promocode

```php
$promocode = Promocode::findByCode('SAVE20');

// –ü—Ä–æ–≤–µ—Ä–∫–∏
$promocode->isValid();                    // –æ–±—â–∞—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
$promocode->canBeUsedByUser($userId);     // –º–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

// –†–∞—Å—á–µ—Ç—ã
$discountAmount = $promocode->calculateDiscountAmount(100.00);  // 20.00
$finalAmount = $promocode->calculateFinalAmount(100.00);        // 80.00

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è
$activation = $promocode->activateForUser($userId, $ip, $userAgent, $paymentId);

// Scopes
Promocode::active()->get();     // —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
Promocode::valid()->get();      // –≤–∞–ª–∏–¥–Ω—ã–µ (–∞–∫—Ç–∏–≤–Ω—ã–µ + –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–∞—Ç)

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
$uniqueCode = Promocode::generateUniqueCode(6); // –¥–ª–∏–Ω–∞ 6 —Å–∏–º–≤–æ–ª–æ–≤
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏–π** - –æ–¥–∏–Ω –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–ª—å–∑—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –¥–≤–∞–∂–¥—ã –∫ –æ–¥–Ω–æ–º—É –ø–ª–∞—Ç–µ–∂—É
2. **–õ–∏–º–∏—Ç—ã –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. **IP —Ç—Ä–µ–∫–∏–Ω–≥** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ IP –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞
5. **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** - –ø—Ä–æ–º–æ–∫–æ–¥—ã –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏

–ü—Ä–æ–º–æ–∫–æ–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —Å —Ç–∞–±–ª–∏—Ü–µ–π `payments` —á–µ—Ä–µ–∑ –ø–æ–ª–µ `promocode_id`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≤ –ø–ª–∞—Ç–µ–∂–∞—Ö
- –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–º–æ–∫–∞–º–ø–∞–Ω–∏–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ
