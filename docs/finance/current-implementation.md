# Текущая реализация финансового модуля

## Обзор

Финансовый модуль представляет собой полноценную реализацию для обработки платежей за подписки и депозитов через платежную систему Pay2.House. Система промокодов полностью реализована и функциональна. Webhook обработка работает и автоматически активирует подписки пользователей.

## Архитектура

### Структура файлов

```
app/Finance/
├── Http/Controllers/
│   ├── FinanceController.php        # Депозиты и история транзакций
│   ├── TariffController.php         # Платежи за тарифы и подписки
│   └── Pay2WebhookController.php    # Полная обработка webhook'ов от Pay2.House
├── Models/
│   ├── Payment.php                  # Модель платежей с полной функциональностью
│   ├── Subscription.php             # Модель подписок
│   ├── Promocode.php                # Модель промокодов
│   └── PromocodeActivation.php      # Активации промокодов
└── Services/
    ├── Pay2Service.php              # Полная интеграция с Pay2.House
    └── PromocodeService.php         # Логика промокодов с защитой от злоупотреблений
```

## Основные компоненты

### 1. FinanceController

**Назначение**: Управление депозитами и историей транзакций

**Основные методы**:

- `index()` - отображение страницы финансов с историей депозитов
- `ajaxList()` - AJAX endpoint для пагинации транзакций
- `depositForm()` - форма пополнения баланса (перенаправляет на index)
- `deposit()` - ✅ **ПОЛНОСТЬЮ РЕАЛИЗОВАН** - обработка депозитов через Pay2.House
- `depositSuccess()` - страница успешного депозита
- `depositCancel()` - страница отмененного депозита

**Поток депозита**:

1. Пользователь заполняет форму с суммой ($50-$1000) и методом оплаты
2. Валидация данных с детальными сообщениями об ошибках
3. Создание платежа через Pay2Service с JWT подписью
4. Сохранение записи о платеже в локальной базе
5. Перенаправление на платежную форму Pay2.House
6. Обработка возврата (success/cancel)

### 2. TariffController

**Назначение**: Обработка платежей за подписки

**Основные методы**:

- `index()` - отображение страницы тарифов с текущими подписками и историей
- `processPayment()` - AJAX создание платежа через Pay2.House
- `payment($slug)` - страница оплаты конкретного тарифа
- `paymentSuccess()` - обработка успешного возврата с оплаты
- `paymentCancel()` - обработка отмененного платежа
- `ajaxPayments()` - AJAX endpoint для пагинации платежей

**Поток оплаты**:

1. Пользователь выбирает тариф и тип биллинга (месяц/год с 20% скидкой)
2. Система создает платеж в Pay2.House через `Pay2Service`
3. Пользователь перенаправляется на платежную форму
4. Pay2.House отправляет webhook при изменении статуса
5. После оплаты возврат на success/cancel страницы

### 3. Pay2WebhookController ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАН

**Назначение**: Обработка webhook'ов от Pay2.House

**Основные методы**:

- `handle()` - обработка входящих webhook'ов с проверкой подписи
- `processWebhookData()` - маршрутизация по статусам (paid/cancelled/error)
- `handlePaidPayment()` - обработка успешной оплаты
- `handleCancelledPayment()` - обработка отмененной оплаты
- `handleErrorPayment()` - обработка ошибок оплаты
- `activateUserSubscription()` - активация подписки пользователя
- `isRenewal()` - проверка на продление существующей подписки

**Поток обработки webhook'а**:

1. Получение webhook'а от Pay2.House
2. Проверка подписи (только в продакшн режиме)
3. Поиск платежа по invoice_number в локальной базе
4. Обновление статуса платежа (SUCCESS/FAILED)
5. Активация подписки пользователя (при успешной оплате)
6. Определение типа операции (продление vs новая подписка)
7. Обновление времени окончания подписки
8. Детальное логирование всех операций

### 4. Pay2Service

**Назначение**: Интеграция с платежной системой Pay2.House

**Основные методы**:

- `createPayment($paymentData)` - создание платежа с JWT подписью
- `getPaymentDetails($invoiceNumber)` - получение деталей платежа
- `createSignToken($data)` - создание JWT токена для аутентификации
- `verifyWebhookSignature($signature, $data)` - проверка подписи webhook'а
- `generateExternalNumber($userId, $tariffId)` - генерация уникального номера

**Особенности**:

- Поддержка тестового и продакшн режимов
- JWT RS256 подписи с приватным ключом
- Mapping методов оплаты (USDT → USDT_TRC20, PAY2.HOUSE → PAY2_HOUSE)
- Автоматическая генерация external_number с префиксами (DP для депозитов, TN для тарифов)
- Полное логирование всех операций
- Timeout 30 секунд для HTTP запросов

### 5. PromocodeService

**Назначение**: Управление промокодами с защитой от злоупотреблений

**Основные методы**:

- `validatePromocode()` - валидация промокода
- `applyPromocode()` - применение промокода
- `createPromocode()` - создание нового промокода
- `getUserPromocodeStats()` - статистика использования
- `checkForAbuse($ipAddress, $userId)` - ✅ **НОВОЕ** - проверка на злоупотребления

**Защита от злоупотреблений**:

- Ограничение 10 активаций с одного IP за 24 часа
- Логирование подозрительной активности
- Отслеживание IP адресов пользователей

### 6. Payment Model

**Основные поля**:

- `user_id` - пользователь
- `amount` - сумма платежа (float)
- `payment_type` - тип платежа (enum: DEPOSIT, DIRECT_SUBSCRIPTION)
- `payment_method` - метод оплаты (enum: USDT, PAY2_HOUSE)
- `status` - статус (enum: PENDING, SUCCESS, FAILED)
- `subscription_id` - связанная подписка
- `promocode_id` - использованный промокод
- `invoice_number` - номер счета в Pay2.House
- `external_number` - уникальный внешний номер
- `webhook_token` - токен для webhook безопасности
- `webhook_processed_at` - время обработки webhook'а
- `idempotency_key` - ключ идемпотентности (UUID)

**Функциональность модели**:

- Автоматическая генерация webhook_token и idempotency_key
- Валидация методов оплаты для депозитов
- Методы для проверки статуса (`isSuccessful()`, `isPending()`, `isFailed()`)
- Методы для изменения статуса (`markAsSuccessful()`, `markAsFailed()`)
- Множество scope методов для фильтрации
- Связи с User, Subscription, Promocode

## Енумы (app/Enums/Finance/)

### PaymentType

- `DEPOSIT` - пополнение баланса
- `DIRECT_SUBSCRIPTION` - прямая оплата подписки

### PaymentMethod

- `USDT` - оплата USDT
- `PAY2_HOUSE` - оплата через Pay2.House

### PaymentStatus

- `PENDING` - ожидает оплаты
- `SUCCESS` - успешно оплачен
- `FAILED` - платеж отклонен

### PromocodeStatus

- `ACTIVE` - активный
- `INACTIVE` - неактивный
- `EXPIRED` - истекший
- `EXHAUSTED` - исчерпанный

## Текущий функционал

### ✅ Реализовано и работает

1. **Прямые платежи за подписки** через Pay2.House ✅
2. **Депозиты пользователей** - ✅ **ПОЛНОСТЬЮ РЕАЛИЗОВАНЫ** через Pay2.House
3. **Webhook обработка** с автоматической активацией подписок ✅
4. **Система промокодов** с валидацией и защитой от злоупотреблений ✅
5. **Модели данных** с полной функциональностью и связями ✅
6. **Безопасность платежей** с JWT RS256 подписями и токенами ✅
7. **История платежей** с AJAX пагинацией ✅
8. **Поддержка месячных и годовых подписок** со скидками 20% ✅
9. **Автоматическое обновление статусов** платежей через webhook'и ✅
10. **Определение типа операции** (новая подписка vs продление) ✅
11. **Валидация данных** с детальными сообщениями об ошибках ✅
12. **Детальное логирование** всех операций ✅

### ❌ НЕ реализовано

1. **Система баланса пользователей** - нет таблицы balance_audit (депозиты работают, но не влияют на баланс)
2. **API эндпоинты** - только фронтенд контроллеры
3. **Комплексные интерфейсы** из архитектурной документации
4. **Webhook логирование** - нет отдельной таблицы webhook_logs
5. **Аудит подписок** - нет таблицы subscription_audit
6. **События и слушатели** - прямое обновление данных без событий
7. **Уведомления пользователей** - после платежей уведомления не отправляются

## Ограничения текущей реализации

1. **Нет системы баланса** - депозиты работают, но не влияют на баланс пользователя (нет таблицы `balance_audit`)
2. **Нет API** - невозможно интегрировать с внешними системами (только web интерфейс)
3. **Простая архитектура** - нет абстракций для будущего развития (прямое обращение к сервисам)
4. **Нет отдельного webhook логирования** - используется общее Laravel логирование
5. **Нет уведомлений пользователей** - после активации подписки уведомления не отправляются
6. **Нет событий** - прямое обновление данных вместо Event-Driven архитектуры

## Следующие шаги для развития

### Приоритет 1 (Критично) ✅ ВЫПОЛНЕНО

1. ✅ Реализовать обработку webhook'ов от Pay2.House
2. ✅ Добавить автоматическую активацию подписок после оплаты
3. ✅ Реализовать депозиты через Pay2.House
4. **ОСТАЕТСЯ**: Протестировать полный цикл оплаты в продакшн

### Приоритет 2 (Важно)

1. **Добавить систему баланса пользователей** - создать таблицы `user_balances` и `balance_audit`
2. **Реализовать API эндпоинты** для мобильных приложений
3. **Добавить webhook логирование** - создать таблицу `webhook_logs`
4. **Интегрировать депозиты с балансом** - пополнение должно увеличивать баланс
5. **Добавить уведомления** - email/push после успешных платежей

### Приоритет 3 (Желательно)

1. **Event-Driven архитектура** - добавить события PaymentProcessed, SubscriptionActivated
2. **Рефакторинг в сторону интерфейсов** из архитектурной документации
3. **Улучшить безопасность** - добавить rate limiting для webhook'ов
4. **Мониторинг** - метрики успешности платежей и webhook'ов
