# Текущая реализация финансового модуля

## Обзор

Финансовый модуль в настоящее время представляет собой базовую реализацию для обработки платежей за подписки через платежную систему Pay2.House. Система промокодов также реализована и функциональна.

## Архитектура

### Структура файлов
```
app/Finance/
├── Http/Controllers/
│   ├── FinanceController.php      # История депозитов
│   ├── TariffController.php       # Платежи за тарифы
│   └── WebhookController.php      # Webhook'и (заглушка)
├── Models/
│   ├── Payment.php                # Модель платежей
│   ├── Subscription.php           # Модель подписок
│   ├── Promocode.php              # Модель промокодов
│   └── PromocodeActivation.php    # Активации промокодов
└── Services/
    ├── Pay2Service.php            # Интеграция с Pay2.House
    └── PromocodeService.php       # Логика промокодов
```

## Основные компоненты

### 1. TariffController
**Назначение**: Обработка платежей за подписки

**Основные методы**:
- `index()` - отображение страницы тарифов с текущими подписками
- `processPayment()` - создание платежа через Pay2.House
- `payment($slug)` - страница оплаты конкретного тарифа
- `paymentSuccess()` - обработка успешного возврата с оплаты
- `paymentCancel()` - обработка отмененного платежа

**Поток оплаты**:
1. Пользователь выбирает тариф и тип биллинга (месяц/год)
2. Система создает платеж в Pay2.House через `Pay2Service`
3. Пользователь перенаправляется на платежную форму
4. После оплаты возврат на success/cancel страницы

### 2. Pay2Service
**Назначение**: Интеграция с платежной системой Pay2.House

**Основные методы**:
- `createPayment($paymentData)` - создание платежа
- `getPaymentDetails($invoiceNumber)` - получение деталей платежа
- `verifyWebhookSignature()` - проверка подписи webhook'а
- `generateExternalNumber()` - генерация уникального номера платежа

**Особенности**:
- Поддержка тестового и продакшн режимов
- HMAC-SHA256 подписи для безопасности
- Автоматическая генерация уникальных номеров платежей

### 3. PromocodeService
**Назначение**: Управление промокодами

**Основные методы**:
- `validatePromocode()` - валидация промокода
- `applyPromocode()` - применение промокода
- `createPromocode()` - создание нового промокода
- `getUserPromocodeStats()` - статистика использования
- `checkForAbuse()` - проверка на злоупотребления

### 4. Payment Model
**Основные поля**:
- `user_id` - пользователь
- `amount` - сумма платежа
- `payment_type` - тип платежа (enum: DEPOSIT, DIRECT_SUBSCRIPTION)
- `payment_method` - метод оплаты (enum: USDT, PAY2_HOUSE)
- `status` - статус (enum: PENDING, SUCCESS, FAILED)
- `subscription_id` - связанная подписка
- `promocode_id` - использованный промокод
- `invoice_number` - номер счета в Pay2.House
- `external_number` - уникальный внешний номер

## Енумы (app/Enums/Finance/)

### PaymentType
- `DEPOSIT` - пополнение баланса
- `DIRECT_SUBSCRIPTION` - прямая оплата подписки

### PaymentMethod
- `USDT` - оплата USDT
- `PAY2_HOUSE` - оплата через Pay2.House

### PaymentStatus
- `PENDING` - ожидает оплаты
- `SUCCESS` - успешно оплачен
- `FAILED` - платеж отклонен

### PromocodeStatus
- `ACTIVE` - активный
- `INACTIVE` - неактивный
- `EXPIRED` - истекший
- `EXHAUSTED` - исчерпанный

## Текущий функционал

### ✅ Реализовано и работает
1. **Прямые платежи за подписки** через Pay2.House
2. **Система промокодов** с валидацией и отслеживанием
3. **Модели данных** с правильными связями
4. **Безопасность платежей** с подписями и токенами
5. **История платежей** (базовое отображение)
6. **Поддержка месячных и годовых подписок** со скидками

### ❌ НЕ реализовано
1. **Система баланса пользователей** - нет таблицы balance_audit
2. **Webhook обработка** - только заглушка в WebhookController
3. **API эндпоинты** - только фронтенд контроллеры
4. **Депозиты** - FinanceController::deposit() не реализован
5. **Комплексные интерфейсы** из документации
6. **Автоматическая активация подписок** после успешной оплаты

## Ограничения текущей реализации

1. **Нет автоматической активации подписок** - после успешной оплаты подписка не активируется автоматически
2. **Webhook не обрабатывается** - статусы платежей не обновляются автоматически
3. **Нет системы баланса** - пользователи не могут пополнять баланс и тратить его
4. **Нет API** - невозможно интегрировать с внешними системами
5. **Простая архитектура** - нет абстракций для будущего развития

## Следующие шаги для развития

### Приоритет 1 (Критично)
1. Реализовать обработку webhook'ов от Pay2.House
2. Добавить автоматическую активацию подписок после оплаты
3. Протестировать полный цикл оплаты

### Приоритет 2 (Важно)
1. Добавить систему баланса пользователей
2. Реализовать API эндпоинты для мобильных приложений
3. Добавить более детальное логирование

### Приоритет 3 (Желательно)
1. Рефакторинг в сторону интерфейсов из документации
2. Добавить события и слушатели
3. Улучшить безопасность и мониторинг