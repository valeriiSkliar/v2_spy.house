# Текущая реализация финансового модуля

## Обзор

Финансовый модуль в настоящее время представляет собой базовую реализацию для обработки платежей за подписки через платежную систему Pay2.House. Система промокодов также реализована и функциональна.

## Архитектура

### Структура файлов
```
app/Finance/
├── Http/Controllers/
│   ├── FinanceController.php      # История депозитов
│   ├── TariffController.php       # Платежи за тарифы
│   └── WebhookController.php      # Webhook'и (заглушка)
├── Models/
│   ├── Payment.php                # Модель платежей
│   ├── Subscription.php           # Модель подписок
│   ├── Promocode.php              # Модель промокодов
│   └── PromocodeActivation.php    # Активации промокодов
└── Services/
    ├── Pay2Service.php            # Интеграция с Pay2.House
    └── PromocodeService.php       # Логика промокодов
```

## Основные компоненты

### 1. TariffController
**Назначение**: Обработка платежей за подписки

**Основные методы**:
- `index()` - отображение страницы тарифов с текущими подписками
- `processPayment()` - создание платежа через Pay2.House
- `payment($slug)` - страница оплаты конкретного тарифа
- `paymentSuccess()` - обработка успешного возврата с оплаты
- `paymentCancel()` - обработка отмененного платежа

**Поток оплаты**:
1. Пользователь выбирает тариф и тип биллинга (месяц/год)
2. Система создает платеж в Pay2.House через `Pay2Service`
3. Пользователь перенаправляется на платежную форму
4. Pay2.House отправляет webhook при изменении статуса
5. После оплаты возврат на success/cancel страницы

### 1.1. Pay2WebhookController ✅ НОВЫЙ
**Назначение**: Обработка webhook'ов от Pay2.House

**Основные методы**:
- `handle()` - обработка входящих webhook'ов
- `processWebhookData()` - маршрутизация по статусам
- `handlePaidPayment()` - обработка успешной оплаты
- `handleCancelledPayment()` - обработка отмененной оплаты
- `handleErrorPayment()` - обработка ошибок оплаты
- `activateUserSubscription()` - активация подписки пользователя

**Поток обработки webhook'а**:
1. Получение webhook'а от Pay2.House
2. Проверка HMAC подписи (в продакшн режиме)
3. Поиск платежа по invoice_number
4. Обновление статуса платежа
5. Активация подписки пользователя (при успешной оплате)
6. Логирование всех операций

### 2. Pay2Service
**Назначение**: Интеграция с платежной системой Pay2.House

**Основные методы**:
- `createPayment($paymentData)` - создание платежа
- `getPaymentDetails($invoiceNumber)` - получение деталей платежа
- `verifyWebhookSignature()` - проверка подписи webhook'а
- `generateExternalNumber()` - генерация уникального номера платежа

**Особенности**:
- Поддержка тестового и продакшн режимов
- HMAC-SHA256 подписи для безопасности
- Автоматическая генерация уникальных номеров платежей

### 3. PromocodeService
**Назначение**: Управление промокодами

**Основные методы**:
- `validatePromocode()` - валидация промокода
- `applyPromocode()` - применение промокода
- `createPromocode()` - создание нового промокода
- `getUserPromocodeStats()` - статистика использования
- `checkForAbuse()` - проверка на злоупотребления

### 4. Payment Model
**Основные поля**:
- `user_id` - пользователь
- `amount` - сумма платежа
- `payment_type` - тип платежа (enum: DEPOSIT, DIRECT_SUBSCRIPTION)
- `payment_method` - метод оплаты (enum: USDT, PAY2_HOUSE)
- `status` - статус (enum: PENDING, SUCCESS, FAILED)
- `subscription_id` - связанная подписка
- `promocode_id` - использованный промокод
- `invoice_number` - номер счета в Pay2.House
- `external_number` - уникальный внешний номер

## Енумы (app/Enums/Finance/)

### PaymentType
- `DEPOSIT` - пополнение баланса
- `DIRECT_SUBSCRIPTION` - прямая оплата подписки

### PaymentMethod
- `USDT` - оплата USDT
- `PAY2_HOUSE` - оплата через Pay2.House

### PaymentStatus
- `PENDING` - ожидает оплаты
- `SUCCESS` - успешно оплачен
- `FAILED` - платеж отклонен

### PromocodeStatus
- `ACTIVE` - активный
- `INACTIVE` - неактивный
- `EXPIRED` - истекший
- `EXHAUSTED` - исчерпанный

## Текущий функционал

### ✅ Реализовано и работает
1. **Прямые платежи за подписки** через Pay2.House
2. **Webhook обработка** с автоматической активацией подписок ✅ НОВОЕ
3. **Система промокодов** с валидацией и отслеживанием
4. **Модели данных** с правильными связями
5. **Безопасность платежей** с HMAC подписями и токенами
6. **История платежей** (базовое отображение)
7. **Поддержка месячных и годовых подписок** со скидками
8. **Автоматическое обновление статусов** платежей через webhook'и

### ❌ НЕ реализовано
1. **Система баланса пользователей** - нет таблицы balance_audit
2. **API эндпоинты** - только фронтенд контроллеры
3. **Депозиты** - FinanceController::deposit() не реализован
4. **Комплексные интерфейсы** из документации
5. **Webhook логирование** - нет таблицы webhook_logs
6. **Аудит подписок** - нет таблицы subscription_audit

## Ограничения текущей реализации

1. **Нет системы баланса** - пользователи не могут пополнять баланс и тратить его
2. **Нет API** - невозможно интегрировать с внешними системами
3. **Простая архитектура** - нет абстракций для будущего развития
4. **Нет webhook логирования** - отсутствует детальный аудит webhook запросов
5. **Нет уведомлений пользователей** - после активации подписки уведомления не отправляются

## Следующие шаги для развития

### Приоритет 1 (Критично) ✅ ВЫПОЛНЕНО
1. ✅ Реализовать обработку webhook'ов от Pay2.House
2. ✅ Добавить автоматическую активацию подписок после оплаты
3. Протестировать полный цикл оплаты в продакшн

### Приоритет 2 (Важно)
1. Добавить систему баланса пользователей
2. Реализовать API эндпоинты для мобильных приложений
3. Добавить более детальное логирование

### Приоритет 3 (Желательно)
1. Рефакторинг в сторону интерфейсов из документации
2. Добавить события и слушатели
3. Улучшить безопасность и мониторинг