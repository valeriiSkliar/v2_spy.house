# Текущая реализация финансового модуля

## Обзор

Финансовый модуль представляет собой полноценную реализацию для обработки платежей за подписки и депозитов через платежную систему Pay2.House. Система промокодов полностью реализована и функциональна. Webhook обработка работает и автоматически активирует подписки пользователей.

## Архитектура

### Структура файлов

```
app/Finance/
├── Http/Controllers/
│   ├── FinanceController.php        # Депозиты и история транзакций
│   ├── TariffController.php         # Платежи за тарифы и подписки
│   └── Pay2WebhookController.php    # Полная обработка webhook'ов от Pay2.House
├── Models/
│   ├── Payment.php                  # Модель платежей с полной функциональностью
│   ├── Subscription.php             # Модель подписок
│   ├── Promocode.php                # Модель промокодов
│   └── PromocodeActivation.php      # Активации промокодов
└── Services/
    ├── Pay2Service.php              # Полная интеграция с Pay2.House
    ├── PromocodeService.php         # Логика промокодов с защитой от злоупотреблений
    └── BalanceService.php           # ✅ НОВЫЙ - управление балансом с безопасностью
```

## Основные компоненты

### 1. FinanceController

**Назначение**: Управление депозитами и историей транзакций

**Основные методы**:

- `index()` - отображение страницы финансов с историей депозитов
- `ajaxList()` - AJAX endpoint для пагинации транзакций
- `depositForm()` - форма пополнения баланса (перенаправляет на index)
- `deposit()` - ✅ **ПОЛНОСТЬЮ РЕАЛИЗОВАН** - обработка депозитов через Pay2.House
- `depositSuccess()` - страница успешного депозита
- `depositCancel()` - страница отмененного депозита

**Поток депозита**:

1. Пользователь заполняет форму с суммой ($50-$1000) и методом оплаты
2. Валидация данных с детальными сообщениями об ошибках
3. Создание платежа через Pay2Service с JWT подписью
4. Сохранение записи о платеже в локальной базе
5. Перенаправление на платежную форму Pay2.House
6. Обработка возврата (success/cancel)

### 2. TariffController ✅ ОБНОВЛЕН

**Назначение**: Обработка платежей за подписки (внешние и с баланса)

**Основные методы**:

- `index()` - отображение страницы тарифов с балансом и историей ✅ **ОБНОВЛЕН**
- `processPayment()` - AJAX создание платежа (поддержка USER_BALANCE) ✅ **ОБНОВЛЕН**
- `processBalancePayment($user, $tariff, $billingType)` - ✅ **НОВЫЙ** - обработка платежей с баланса
- `payment($slug)` - страница оплаты с информацией о балансе ✅ **ОБНОВЛЕН**
- `paymentSuccess()` - обработка успешного возврата с оплаты
- `paymentCancel()` - обработка отмененного платежа
- `ajaxPayments()` - AJAX endpoint для пагинации платежей

**Поток оплаты с баланса** ✅ **НОВЫЙ**:

1. Пользователь выбирает тариф и payment_method = 'USER_BALANCE'
2. Система вызывает processBalancePayment()
3. BalanceService проверяет и списывает средства
4. Подписка активируется немедленно
5. Возврат JSON с результатом операции

**Поток внешней оплаты**:

1. Пользователь выбирает тариф и тип биллинга (месяц/год с 20% скидкой)
2. Система создает платеж в Pay2.House через `Pay2Service`
3. Пользователь перенаправляется на платежную форму
4. Pay2.House отправляет webhook при изменении статуса
5. После оплаты возврат на success/cancel страницы

### 3. Pay2WebhookController ✅ ОБНОВЛЕН

**Назначение**: Обработка webhook'ов от Pay2.House (подписки и депозиты)

**Основные методы**:

- `handle()` - обработка входящих webhook'ов с проверкой подписи
- `processWebhookData()` - маршрутизация по статусам (paid/cancelled/error)
- `handlePaidPayment()` - обработка успешной оплаты (подписки и депозиты) ✅ **ОБНОВЛЕН**
- `handleDepositPayment($payment)` - ✅ **НОВЫЙ** - пополнение баланса при депозите
- `handleCancelledPayment()` - обработка отмененной оплаты
- `handleErrorPayment()` - обработка ошибок оплаты
- `activateUserSubscription()` - активация подписки пользователя
- `isRenewal()` - проверка на продление существующей подписки

**Поток обработки webhook'а**:

1. Получение webhook'а от Pay2.House
2. Проверка подписи (только в продакшн режиме)
3. Поиск платежа по invoice_number в локальной базе
4. Обновление статуса платежа (SUCCESS/FAILED)
5. **Маршрутизация по типу платежа** ✅ **НОВОЕ**:
   - **DEPOSIT**: Пополнение баланса через BalanceService
   - **DIRECT_SUBSCRIPTION**: Активация подписки пользователя
6. Определение типа операции (продление vs новая подписка)
7. Обновление времени окончания подписки
8. Детальное логирование всех операций

### 4. Pay2Service

**Назначение**: Интеграция с платежной системой Pay2.House

**Основные методы**:

- `createPayment($paymentData)` - создание платежа с JWT подписью
- `getPaymentDetails($invoiceNumber)` - получение деталей платежа
- `createSignToken($data)` - создание JWT токена для аутентификации
- `verifyWebhookSignature($signature, $data)` - проверка подписи webhook'а
- `generateExternalNumber($userId, $tariffId)` - генерация уникального номера

**Особенности**:

- Поддержка тестового и продакшн режимов
- JWT RS256 подписи с приватным ключом
- Mapping методов оплаты (USDT → USDT_TRC20, PAY2.HOUSE → PAY2_HOUSE)
- Автоматическая генерация external_number с префиксами (DP для депозитов, TN для тарифов)
- Полное логирование всех операций
- Timeout 30 секунд для HTTP запросов

### 5. PromocodeService

**Назначение**: Управление промокодами с защитой от злоупотреблений

**Основные методы**:

- `validatePromocode()` - валидация промокода
- `applyPromocode()` - применение промокода
- `createPromocode()` - создание нового промокода
- `getUserPromocodeStats()` - статистика использования
- `checkForAbuse($ipAddress, $userId)` - ✅ **НОВОЕ** - проверка на злоупотребления

**Защита от злоупотреблений**:

- Ограничение 10 активаций с одного IP за 24 часа
- Логирование подозрительной активности
- Отслеживание IP адресов пользователей

### 6. BalanceService ✅ **НОВЫЙ СЕРВИС**

**Назначение**: Управление балансом пользователей с полной безопасностью

**Основные методы**:

- `processSubscriptionPaymentFromBalance($user, $subscription, $billingType)` - оплата подписки с баланса
- `hasInsufficientBalance($user, $amount)` - проверка достаточности средств
- `addToBalance($user, $amount, $description)` - пополнение баланса
- `deductFromBalance($user, $amount)` - списание с баланса (protected)
- `activateSubscription($user, $subscription, $billingType)` - активация подписки (protected)

**Меры безопасности**:

- **Optimistic locking** через `balance_version` - предотвращение race conditions
- **Database transactions** - все операции атомарны
- **Double-checking** баланса после блокировки
- **Детальное логирование** всех операций с балансом
- **Валидация входных данных** на всех уровнях

**Поток оплаты с баланса**:

1. Проверка достаточности средств
2. Начало транзакции с блокировкой пользователя
3. Повторная проверка баланса после блокировки
4. Создание записи о платеже
5. Списание средств с обновлением версии
6. Активация подписки
7. Завершение транзакции

### 7. Payment Model

**Основные поля**:

- `user_id` - пользователь
- `amount` - сумма платежа (float)
- `payment_type` - тип платежа (enum: DEPOSIT, DIRECT_SUBSCRIPTION)
- `payment_method` - метод оплаты (enum: USDT, PAY2_HOUSE)
- `status` - статус (enum: PENDING, SUCCESS, FAILED)
- `subscription_id` - связанная подписка
- `promocode_id` - использованный промокод
- `invoice_number` - номер счета в Pay2.House
- `external_number` - уникальный внешний номер
- `webhook_token` - токен для webhook безопасности
- `webhook_processed_at` - время обработки webhook'а
- `idempotency_key` - ключ идемпотентности (UUID)

**Функциональность модели**:

- Автоматическая генерация webhook_token и idempotency_key
- **Валидация методов оплаты** ✅ **ОБНОВЛЕНА**:
  - DEPOSIT может использовать только USDT и PAY2_HOUSE
  - USER_BALANCE может использоваться только для DIRECT_SUBSCRIPTION
- Методы для проверки статуса (`isSuccessful()`, `isPending()`, `isFailed()`)
- Методы для изменения статуса (`markAsSuccessful()`, `markAsFailed()`)
- Множество scope методов для фильтрации
- Связи с User, Subscription, Promocode

### 8. User Model ✅ **ИСПРАВЛЕНА ЛОГИКА**

**Исправления в логике подписок**:

**Новые методы**:

- `hasActiveSubscription()` - ✅ **НОВЫЙ** - проверка активной подписки
- `hasTariff($subscriptionId = null)` - ✅ **ИСПРАВЛЕН** - теперь использует новые поля подписки
- `getFormattedBalance()` - ✅ **НОВЫЙ** - форматированный баланс
- `hasSufficientBalance($amount)` - ✅ **НОВЫЙ** - проверка достаточности баланса

**Обновленные методы**:

- `currentTariff()` - ✅ **ОБНОВЛЕН** - добавлено поле `is_active`
- `tariffExpiresAt()` - ✅ **ИСПРАВЛЕН** - использует `subscription_time_end`

**Логика проверки активности**:

- Использует `subscription_id`, `subscription_time_end`, `subscription_is_expired`
- Убрана зависимость от устаревших полей `tariff_id`/`tariff_expires_at`
- Консистентная логика между всеми методами

### 9. Frontend Integration ✅ **ОБНОВЛЕНО**

**Header Component** (`resources/views/partials/header.blade.php`):

- ✅ **ИСПРАВЛЕНА** логика отображения тарифа - использует правильные методы
- ✅ **ДОБАВЛЕНО** отображение баланса пользователя в хедере
- ✅ **УЛУЧШЕНА** структура кода - убрано дублирование элементов
- ✅ **ДОБАВЛЕНЫ** CSS стили для баланса (`header-balance.css`)

**Новый функционал в интерфейсе**:

- Показ баланса пользователя только если баланс > 0
- Красивое форматирование суммы баланса
- Адаптивный дизайн для мобильных устройств
- Hover эффекты для потенциального клика (переход к финансам)

**JavaScript обновления** (`resources/js/tariffs.js`):

- ✅ **ОБНОВЛЕН** для поддержки платежей с USER_BALANCE
- ✅ **ДОБАВЛЕНА** проверка достаточности баланса в реальном времени
- ✅ **ДОБАВЛЕНЫ** предупреждения о недостаточном балансе
- ✅ **ДОБАВЛЕНА** различная обработка внешних и внутренних платежей
- ✅ **ДОБАВЛЕНО** обновление стоимости при смене billing_type
- ✅ **ДОБАВЛЕНЫ** сообщения об успехе для платежей с баланса

### 10. Testing Coverage ✅ **НОВОЕ**

**Тесты для BalanceService** (`tests/Feature/Finance/BalanceServiceTest.php`):

- ✅ Проверка достаточности баланса
- ✅ Пополнение баланса
- ✅ Оплата подписки с баланса
- ✅ Применение годовых скидок
- ✅ Optimistic locking (предотвращение race conditions)
- ✅ Обработка недостаточного баланса

**Тесты для User Model** (`tests/Unit/Models/UserSubscriptionTest.php`):

- ✅ Проверка активности подписки в различных сценариях
- ✅ Проверка конкретных подписок
- ✅ Корректность метода `currentTariff()`
- ✅ Форматирование баланса
- ✅ Проверка достаточности средств
- ✅ Корректность дат истечения

## Енумы (app/Enums/Finance/)

### PaymentType

- `DEPOSIT` - пополнение баланса
- `DIRECT_SUBSCRIPTION` - прямая оплата подписки

### PaymentMethod

- `USDT` - оплата USDT
- `PAY2_HOUSE` - оплата через Pay2.House
- `USER_BALANCE` - ✅ **НОВОЕ** - оплата с баланса пользователя

### PaymentStatus

- `PENDING` - ожидает оплаты
- `SUCCESS` - успешно оплачен
- `FAILED` - платеж отклонен

### PromocodeStatus

- `ACTIVE` - активный
- `INACTIVE` - неактивный
- `EXPIRED` - истекший
- `EXHAUSTED` - исчерпанный

## Текущий функционал

### ✅ Реализовано и работает

1. **Прямые платежи за подписки** через Pay2.House ✅
2. **Депозиты пользователей** - ✅ **ПОЛНОСТЬЮ РЕАЛИЗОВАНЫ** через Pay2.House
3. **Оплата подписок с баланса** - ✅ **НОВОЕ** - полная поддержка USER_BALANCE ✅
4. **Автоматическое пополнение баланса** при депозитах ✅ **НОВОЕ**
5. **Отображение баланса в интерфейсе** - показ баланса в хедере ✅ **НОВОЕ**
6. **Логика проверки активных подписок** - исправлена для работы с новой системой ✅ **ИСПРАВЛЕНО**
7. **Webhook обработка** с автоматической активацией подписок ✅
8. **Система промокодов** с валидацией и защитой от злоупотреблений ✅
9. **Модели данных** с полной функциональностью и связями ✅
10. **Безопасность платежей** с JWT RS256 подписями и токенами ✅
11. **Optimistic locking** для операций с балансом (предотвращение race conditions) ✅ **НОВОЕ**
12. **История платежей** с AJAX пагинацией ✅
13. **Поддержка месячных и годовых подписок** со скидками 20% ✅
14. **Автоматическое обновление статусов** платежей через webhook'и ✅
15. **Определение типа операции** (новая подписка vs продление) ✅
16. **Валидация данных** с детальными сообщениями об ошибках ✅
17. **Детальное логирование** всех операций ✅
18. **Тестовое покрытие** - тесты для BalanceService и User модели ✅ **НОВОЕ**
19. **Фронтенд интеграция USER_BALANCE** - полная поддержка оплаты с баланса ✅ **ИСПРАВЛЕНО**

### ❌ НЕ реализовано

1. **Подробный аудит баланса** - нет таблицы balance_audit для истории изменений
2. **API эндпоинты** - только фронтенд контроллеры
3. **Комплексные интерфейсы** из архитектурной документации
4. **Webhook логирование** - нет отдельной таблицы webhook_logs
5. **Аудит подписок** - нет таблицы subscription_audit
6. **События и слушатели** - прямое обновление данных без событий
7. **Уведомления пользователей** - после платежей уведомления не отправляются
8. **Возврат средств** - нет механизма отмены подписок с возвратом на баланс

## Ограничения текущей реализации

1. **Нет детального аудита баланса** - нет таблицы `balance_audit` для отслеживания истории операций
2. **Нет API** - невозможно интегрировать с внешними системами (только web интерфейс)
3. **Простая архитектура** - нет абстракций для будущего развития (прямое обращение к сервисам)
4. **Нет отдельного webhook логирования** - используется общее Laravel логирование
5. **Нет уведомлений пользователей** - после активации подписки уведомления не отправляются
6. **Нет событий** - прямое обновление данных вместо Event-Driven архитектуры
7. **Нет возврата средств** - невозможно отменить подписку с возвратом денег на баланс

## Следующие шаги для развития

### Приоритет 1 (Критично) ✅ ПОЛНОСТЬЮ ВЫПОЛНЕНО

1. ✅ Реализовать обработку webhook'ов от Pay2.House
2. ✅ Добавить автоматическую активацию подписок после оплаты
3. ✅ Реализовать депозиты через Pay2.House
4. ✅ Интегрировать депозиты с балансом пользователя
5. ✅ Добавить оплату подписок с баланса (USER_BALANCE)
6. **ОСТАЕТСЯ**: Протестировать полный цикл оплаты в продакшн

### Приоритет 2 (Важно)

1. **Добавить детальный аудит баланса** - создать таблицу `balance_audit`
2. **Реализовать API эндпоинты** для мобильных приложений
3. **Добавить webhook логирование** - создать таблицу `webhook_logs`
4. **Добавить уведомления** - email/push после успешных платежей
5. **Механизм возврата средств** - отмена подписок с возвратом на баланс

### Приоритет 3 (Желательно)

1. **Event-Driven архитектура** - добавить события PaymentProcessed, SubscriptionActivated
2. **Рефакторинг в сторону интерфейсов** из архитектурной документации
3. **Улучшить безопасность** - добавить rate limiting для webhook'ов
4. **Мониторинг** - метрики успешности платежей и webhook'ов
