<?php

namespace Tests\Feature\DTOs\Parsers;

use App\Enums\Frontend\AdvertisingFormat;
use App\Enums\Frontend\AdvertisingStatus;
use App\Enums\Frontend\Platform;
use App\Http\DTOs\Parsers\PushHouseCreativeDTO;
use App\Models\AdSource;
use App\Models\AdvertismentNetwork;
use App\Models\Frontend\IsoEntity;
use Carbon\Carbon;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;
use Tests\Traits\DatabaseSeeding;

class PushHouseCreativeDTOTest extends TestCase
{
    use RefreshDatabase, DatabaseSeeding;

    protected function setUp(): void
    {
        parent::setUp();
        $this->seedTestData();
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    protected function seedTestData(): void
    {
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω—ã
        $this->seedTestCountries();

        // –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ push_house
        AdSource::create([
            'source_name' => 'push_house',
            'source_display_name' => 'Push House',
        ]);

        // –°–æ–∑–¥–∞–µ–º —Ä–µ–∫–ª–∞–º–Ω—É—é —Å–µ—Ç—å pushhouse
        AdvertismentNetwork::create([
            'network_name' => 'pushhouse',
            'network_display_name' => 'Push House',
            'description' => 'Push House advertising network for testing',
            'traffic_type_description' => 'push',
            'network_url' => 'https://push.house',
            'is_active' => true,
        ]);
    }

    /**
     * –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è DTO –∏–∑ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö API Push.House
     */
    public function test_creates_dto_from_new_api_format(): void
    {
        $apiData = [
            'id' => 1393905,
            'title' => 'üò± PARAB√âNS! VOC√ä GANHOU! üíµ',
            'text' => '‚úÖ B√îNUS R$4,675 + 100 GIRADAS GR√ÅTIS ü§ë',
            'icon' => 'https://s3.push.house/icon.png',
            'img' => 'https://s3.push.house/image.png',
            'url' => 'https://example.com/?creative_id={camp}&source={site}',
            'cpc' => '0.00770000',
            'country' => 'BR',
            'platform' => 'Mob',
            'isAdult' => false,
            'isActive' => true,
            'created_at' => '2025-07-03'
        ];

        $dto = PushHouseCreativeDTO::fromApiResponse($apiData);

        $this->assertEquals(1393905, $dto->externalId);
        $this->assertEquals('üò± PARAB√âNS! VOC√ä GANHOU! üíµ', $dto->title);
        $this->assertEquals('‚úÖ B√îNUS R$4,675 + 100 GIRADAS GR√ÅTIS ü§ë', $dto->text);
        $this->assertEquals('https://s3.push.house/icon.png', $dto->iconUrl);
        $this->assertEquals('https://s3.push.house/image.png', $dto->imageUrl);
        $this->assertEquals('https://example.com/?creative_id={camp}&source={site}', $dto->targetUrl);
        $this->assertEquals(0.0077, $dto->cpc);
        $this->assertEquals('BR', $dto->countryCode);
        $this->assertEquals(Platform::MOBILE, $dto->platform);
        $this->assertFalse($dto->isAdult);
        $this->assertTrue($dto->isActive);
        $this->assertEquals('push_house', $dto->source);
        $this->assertInstanceOf(Carbon::class, $dto->createdAt);
    }

    /**
     * –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è DTO –∏–∑ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Å–µ—Ä–∞ (legacy format)
     */
    public function test_creates_dto_from_legacy_parser_format(): void
    {
        $legacyData = [
            'res_uniq_id' => 12345,
            'title' => 'Legacy Title',
            'text' => 'Legacy Description',
            'icon' => 'https://legacy.com/icon.png',
            'img' => 'https://legacy.com/image.png',
            'url' => 'https://legacy.com/landing',
            'price_cpc' => 0.05,
            'country' => 'us',
            'platform' => 'mobile', // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            'isAdult' => true,
            'isActive' => false
        ];

        $dto = PushHouseCreativeDTO::fromApiResponse($legacyData);

        $this->assertEquals(12345, $dto->externalId);
        $this->assertEquals('Legacy Title', $dto->title);
        $this->assertEquals('Legacy Description', $dto->text);
        $this->assertEquals('https://legacy.com/icon.png', $dto->iconUrl);
        $this->assertEquals('https://legacy.com/image.png', $dto->imageUrl);
        $this->assertEquals('https://legacy.com/landing', $dto->targetUrl);
        $this->assertEquals(0.05, $dto->cpc);
        $this->assertEquals('US', $dto->countryCode); // –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–≤–µ–¥–µ–Ω –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
        $this->assertEquals(Platform::MOBILE, $dto->platform); // platform: mobile -> MOBILE
        $this->assertTrue($dto->isAdult);
        $this->assertFalse($dto->isActive);
    }

    /**
     * –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—É—Å—Ç—ã—Ö/–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    public function test_handles_empty_and_missing_data(): void
    {
        $emptyData = [];

        $dto = PushHouseCreativeDTO::fromApiResponse($emptyData);

        $this->assertEquals(0, $dto->externalId);
        $this->assertEquals('', $dto->title);
        $this->assertEquals('', $dto->text);
        $this->assertEquals('', $dto->iconUrl);
        $this->assertEquals('', $dto->imageUrl);
        $this->assertEquals('', $dto->targetUrl);
        $this->assertEquals(0.0, $dto->cpc);
        $this->assertEquals('', $dto->countryCode);
        $this->assertEquals(Platform::MOBILE, $dto->platform); // Fallback
        $this->assertFalse($dto->isAdult);
        $this->assertTrue($dto->isActive); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é true
    }

    /**
     * –¢–µ—Å—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
     */
    public function test_platform_normalization(): void
    {
        // –¢–µ—Å—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        $testCases = [
            // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç API
            [['platform' => 'Mob'], Platform::MOBILE],
            [['platform' => 'Desktop'], Platform::DESKTOP],
            [['platform' => 'mobile'], Platform::MOBILE],

            // Fallback
            [[], Platform::MOBILE],
        ];

        foreach ($testCases as [$input, $expectedPlatform]) {
            $dto = PushHouseCreativeDTO::fromApiResponse($input);
            $this->assertEquals(
                $expectedPlatform,
                $dto->platform,
                'Failed for input: ' . json_encode($input)
            );
        }
    }

    /**
     * –¢–µ—Å—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç –ë–î —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä–∞–º–∏
     */
    public function test_transforms_to_database_format(): void
    {
        $apiData = [
            'id' => 1393905,
            'title' => 'Test Title',
            'text' => 'Test Description',
            'icon' => 'https://example.com/icon.png',
            'img' => 'https://example.com/image.png',
            'url' => 'https://example.com/landing',
            'cpc' => '0.05',
            'country' => 'US',
            'platform' => 'Mob',
            'isAdult' => true,
            'isActive' => true,
            'created_at' => '2025-07-03'
        ];

        $dto = PushHouseCreativeDTO::fromApiResponse($apiData);
        $databaseData = $dto->toDatabase();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
        $this->assertEquals(1393905, $databaseData['external_id']);
        $this->assertEquals('Test Title', $databaseData['title']);
        $this->assertEquals('Test Description', $databaseData['description']);
        $this->assertEquals('https://example.com/icon.png', $databaseData['icon_url']);
        $this->assertEquals('https://example.com/image.png', $databaseData['main_image_url']);
        $this->assertEquals('https://example.com/landing', $databaseData['landing_url']);
        $this->assertEquals('mobile', $databaseData['platform']);
        $this->assertTrue($databaseData['is_adult']);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º enum –∑–Ω–∞—á–µ–Ω–∏—è
        $this->assertEquals(AdvertisingStatus::Active, $databaseData['status']);
        $this->assertEquals(AdvertisingFormat::PUSH, $databaseData['format']);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        $this->assertArrayHasKey('combined_hash', $databaseData);
        $this->assertArrayHasKey('created_at', $databaseData);
        $this->assertArrayHasKey('updated_at', $databaseData);
        $this->assertArrayHasKey('external_created_at', $databaseData);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ ID (–¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
        $this->assertArrayHasKey('source_id', $databaseData);
        $this->assertArrayHasKey('country_id', $databaseData);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä—ã —Å—Ä–∞–±–æ—Ç–∞–ª–∏
        $this->assertNotNull($databaseData['source_id']); // push_house –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏—Å—å
        $this->assertNotNull($databaseData['country_id']); // US –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏—Å—å
    }

    /**
     * –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∞
     */
    public function test_generates_consistent_hash(): void
    {
        $apiData = [
            'id' => 1393905,
            'title' => 'Test Title',
            'text' => 'Test Description',
            'country' => 'US',
        ];

        $dto1 = PushHouseCreativeDTO::fromApiResponse($apiData);
        $dto2 = PushHouseCreativeDTO::fromApiResponse($apiData);

        $databaseData1 = $dto1->toDatabase();
        $databaseData2 = $dto2->toDatabase();

        // –•–µ—à–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        $this->assertEquals($databaseData1['combined_hash'], $databaseData2['combined_hash']);

        // –•–µ—à –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 64-—Å–∏–º–≤–æ–ª—å–Ω—ã–º SHA256
        $this->assertEquals(64, strlen($databaseData1['combined_hash']));
        $this->assertMatchesRegularExpression('/^[a-f0-9]{64}$/', $databaseData1['combined_hash']);
    }

    /**
     * –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ DTO
     */
    public function test_validates_dto_data(): void
    {
        // –í–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º)
        $validData = [
            'id' => 123,
            'country' => 'US',
            'icon' => 'https://example.com/icon.png' // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        ];
        $validDto = PushHouseCreativeDTO::fromApiResponse($validData);
        $this->assertTrue($validDto->isValid());

        // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –Ω–µ—Ç external_id
        $invalidData1 = [
            'country' => 'US',
            'icon' => 'https://example.com/icon.png'
        ];
        $invalidDto1 = PushHouseCreativeDTO::fromApiResponse($invalidData1);
        $this->assertFalse($invalidDto1->isValid());

        // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –Ω–µ—Ç country
        $invalidData2 = [
            'id' => 123,
            'icon' => 'https://example.com/icon.png'
        ];
        $invalidDto2 = PushHouseCreativeDTO::fromApiResponse($invalidData2);
        $this->assertFalse($invalidDto2->isValid());

        // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        $invalidData3 = [
            'id' => 0,
            'country' => ''
        ];
        $invalidDto3 = PushHouseCreativeDTO::fromApiResponse($invalidData3);
        $this->assertFalse($invalidDto3->isValid());

        // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        $invalidData4 = [
            'id' => 123,
            'country' => 'US'
            // –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        ];
        $invalidDto4 = PushHouseCreativeDTO::fromApiResponse($invalidData4);
        $this->assertFalse($invalidDto4->isValid());
    }

    /**
     * –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
     */
    public function test_handles_activity_status(): void
    {
        // –ê–∫—Ç–∏–≤–Ω—ã–π –∫—Ä–µ–∞—Ç–∏–≤
        $activeData = ['id' => 123, 'country' => 'US', 'isActive' => true];
        $activeDto = PushHouseCreativeDTO::fromApiResponse($activeData);
        $activeDatabaseData = $activeDto->toDatabase();
        $this->assertEquals(AdvertisingStatus::Active, $activeDatabaseData['status']);

        // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π –∫—Ä–µ–∞—Ç–∏–≤
        $inactiveData = ['id' => 124, 'country' => 'US', 'isActive' => false];
        $inactiveDto = PushHouseCreativeDTO::fromApiResponse($inactiveData);
        $inactiveDatabaseData = $inactiveDto->toDatabase();
        $this->assertEquals(AdvertisingStatus::Inactive, $inactiveDatabaseData['status']);

        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–∫—Ç–∏–≤–Ω—ã–π (–µ—Å–ª–∏ –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
        $defaultData = ['id' => 125, 'country' => 'US'];
        $defaultDto = PushHouseCreativeDTO::fromApiResponse($defaultData);
        $defaultDatabaseData = $defaultDto->toDatabase();
        $this->assertEquals(AdvertisingStatus::Active, $defaultDatabaseData['status']);
    }

    /**
     * –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç
     */
    public function test_handles_dates(): void
    {
        // –° —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç–æ–π
        $dataWithDate = [
            'id' => 123,
            'country' => 'US',
            'created_at' => '2025-07-03 10:30:00'
        ];
        $dto = PushHouseCreativeDTO::fromApiResponse($dataWithDate);
        $this->assertEquals('2025-07-03 10:30:00', $dto->createdAt->format('Y-m-d H:i:s'));

        // –ë–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã (–¥–æ–ª–∂–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–µ–∫—É—â–∞—è)
        $dataWithoutDate = [
            'id' => 124,
            'country' => 'US'
        ];
        $dtoWithoutDate = PushHouseCreativeDTO::fromApiResponse($dataWithoutDate);
        $this->assertInstanceOf(Carbon::class, $dtoWithoutDate->createdAt);
    }

    /**
     * –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä–∞–º–∏
     */
    public function test_integration_with_normalizers(): void
    {
        $apiData = [
            'id' => 999,
            'country' => 'CA', // –ö–∞–Ω–∞–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            'title' => 'Integration Test',
            'text' => 'Testing normalizers integration'
        ];

        $dto = PushHouseCreativeDTO::fromApiResponse($apiData);
        $databaseData = $dto->toDatabase();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª—Å—è
        $source = AdSource::find($databaseData['source_id']);
        $this->assertNotNull($source);
        $this->assertEquals('push_house', $source->source_name);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª–∞—Å—å
        $country = IsoEntity::find($databaseData['country_id']);
        $this->assertNotNull($country);
        $this->assertEquals('CA', $country->iso_code_2);
        $this->assertEquals('country', $country->type);
    }

    /**
     * –¢–µ—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∫—Ä–µ–∞—Ç–∏–≤–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
     */
    public function test_determines_advertising_format_based_on_images(): void
    {
        // –¢–µ—Å—Ç PUSH —Ñ–æ—Ä–º–∞—Ç–∞ (–æ–±–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç)
        $pushData = [
            'id' => 1395508,
            'title' => 'Test Push Creative',
            'text' => 'Test Description',
            'icon' => 'https://s3.push.house/push.house-camps/100778/686b6454abb47.png',
            'img' => 'https://s3.push.house/push.house-camps/100778/686b6454a812e.png',
            'country' => 'US'
        ];

        $pushDto = PushHouseCreativeDTO::fromApiResponse($pushData);
        $pushDatabaseData = $pushDto->toDatabase();

        $this->assertEquals(AdvertisingFormat::PUSH, $pushDatabaseData['format']);
        $this->assertTrue($pushDto->isValid());

        // –¢–µ—Å—Ç INPAGE —Ñ–æ—Ä–º–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ icon –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
        $inpageData = [
            'id' => 1395482,
            'title' => 'Test Inpage Creative',
            'text' => 'Test Description',
            'icon' => 'https://s3.push.house/push.house-camps/102659/686b2495da589.png',
            'img' => 'https://s3.push.house/push.house-camps/102659/', // –ù–µ—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            'country' => 'US'
        ];

        $inpageDto = PushHouseCreativeDTO::fromApiResponse($inpageData);
        $inpageDatabaseData = $inpageDto->toDatabase();

        $this->assertEquals(AdvertisingFormat::INPAGE, $inpageDatabaseData['format']);
        $this->assertTrue($inpageDto->isValid());

        // –¢–µ—Å—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–∞ (–Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª–æ–≤)
        $invalidData = [
            'id' => 1395509,
            'title' => '',
            'text' => '',
            'icon' => 'https://s3.push.house/push.house-camps/28718/', // –ù–µ—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            'img' => 'https://s3.push.house/push.house-camps/28718/', // –ù–µ—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            'country' => 'US'
        ];

        $invalidDto = PushHouseCreativeDTO::fromApiResponse($invalidData);

        $this->assertFalse($invalidDto->isValid(), '–ö—Ä–µ–∞—Ç–∏–≤ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º');
    }

    /**
     * –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
     */
    public function test_image_url_validation(): void
    {
        $testCases = [
            // –í–∞–ª–∏–¥–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            [['icon' => 'https://example.com/image.png'], true, 'Valid PNG image'],
            [['icon' => 'https://example.com/image.jpg'], true, 'Valid JPG image'],
            [['img' => 'https://s3.push.house/camps/123/abc123.gif'], true, 'Valid GIF image'],

            // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            [['icon' => 'https://example.com/'], false, 'URL ending with slash'],
            [['icon' => 'https://example.com/path/'], false, 'Path ending with slash'],
            [['icon' => 'https://example.com/filename'], false, 'No file extension'],
            [['icon' => ''], false, 'Empty URL'],
        ];

        foreach ($testCases as [$imageData, $expectedValid, $description]) {
            $data = array_merge([
                'id' => 123,
                'country' => 'US',
                'icon' => '',
                'img' => ''
            ], $imageData);

            $dto = PushHouseCreativeDTO::fromApiResponse($data);

            $this->assertEquals(
                $expectedValid,
                $dto->isValid(),
                "Failed for case: {$description}"
            );
        }
    }

    /**
     * –¢–µ—Å—Ç –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞
     */
    public function test_format_determination_edge_cases(): void
    {
        // –¢–æ–ª—å–∫–æ img –±–µ–∑ icon ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å PUSH —Å fallback –ª–æ–≥–∏–∫–æ–π
        $onlyImgData = [
            'id' => 123,
            'country' => 'US',
            'icon' => '', // –ü—É—Å—Ç–æ–π
            'img' => 'https://example.com/image.png'
        ];

        $onlyImgDto = PushHouseCreativeDTO::fromApiResponse($onlyImgData);
        $onlyImgDatabaseData = $onlyImgDto->toDatabase();

        $this->assertEquals(AdvertisingFormat::PUSH, $onlyImgDatabaseData['format']);
        $this->assertTrue($onlyImgDto->isValid());

        // –û–±–∞ URL –ø—É—Å—Ç—ã–µ
        $noImagesData = [
            'id' => 124,
            'country' => 'US',
            'icon' => '',
            'img' => ''
        ];

        $noImagesDto = PushHouseCreativeDTO::fromApiResponse($noImagesData);

        $this->assertFalse($noImagesDto->isValid());

        // –û–±–∞ URL –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è —Å–ª–µ—à–µ–º
        $slashEndingData = [
            'id' => 125,
            'country' => 'US',
            'icon' => 'https://example.com/path/',
            'img' => 'https://example.com/other/'
        ];

        $slashEndingDto = PushHouseCreativeDTO::fromApiResponse($slashEndingData);

        $this->assertFalse($slashEndingDto->isValid());
    }
}
